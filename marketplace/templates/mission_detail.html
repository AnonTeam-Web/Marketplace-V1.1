<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Détails de l'annonce</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7fb; }
    .container { max-width: 700px; margin-top: 40px; }
    .card { border-radius: 12px; }
    .card-img-top { object-fit: cover; height: 250px; border-top-left-radius: 12px; border-top-right-radius: 12px; }
    .price { color: #0d6efd; font-weight: 700; font-size: 1.2rem; }
    .badge-type { background: rgba(13,110,253,0.08); color: #0d6efd; font-weight: 600; border-radius: 8px; padding: 4px 8px; font-size: .85rem; }
    .offre-accepted { background-color: #d4edda; }
    .icon-type { font-size: 1.5rem; vertical-align: middle; margin-right: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card shadow">
      <div class="card-body">
        <h3 class="card-title">{{ mission.titre }}</h3>

        <!-- Pictogramme dynamique -->
        {% set type_icon = {
             'information': 'bi-info-circle',
             'carte': 'bi-map',
             'mission': 'bi-flag',
             'option': 'bi-lightbulb'
           } %}
        <div class="mb-2">
          <span class="badge-type">
            <i class="bi {{ type_icon.get(mission.type, 'bi-question-circle') }} icon-type"></i>
            {{ mission.type }}
          </span>
          <span class="ms-2">Qté: {{ mission.quantity }}</span>
        </div>

        <p class="card-text">{{ mission.description }}</p>

        <div class="mb-3">
          <div class="price">Prix demandé : {{ mission.prix }} crédits</div>
          <div>Vendeur : <strong>{{ mission.vendeur }}</strong></div>
          {% if mission.date_butoir %}
            <div>Fin de vente : <strong>{{ mission.date_butoir[:10] }}</strong></div>
          {% endif %}
        </div>

        {% if mission.offres %}
          <h5>Offres reçues :</h5>
          <ul class="list-group mb-3">
            {% for offre in mission.offres %}
              <li class="list-group-item d-flex justify-content-between align-items-center {% if offre.accepted %}offre-accepted{% endif %}">
                <div>
                  <strong>{{ offre.user }}</strong> propose {{ offre.prix }} crédits
                  {% if offre.accepted %}
                    <span class="badge bg-success ms-2">Acceptée</span>
                  {% endif %}
                </div>

                <!-- Actions selon le rôle -->
                <div class="d-flex gap-1">
                  {% if session.get('user') == mission.vendeur and not offre.accepted %}
                    <form method="POST" action="{{ url_for('accept_offer', mission_id=mission.id) }}" style="display:inline">
                      <input type="hidden" name="user" value="{{ offre.user }}">
                      <input type="hidden" name="prix" value="{{ offre.prix }}">
                      {% if mission.quantity > 0 %}
                        <button type="submit" class="btn btn-success btn-sm">Accepter</button>
                      {% else %}
                        <span class="text-danger">Stock épuisé</span>
                      {% endif %}
                    </form>
                  {% endif %}

                  {% if session.get('user') == offre.user and not offre.accepted %}
                    <form method="POST" action="{{ url_for('delete_offer', mission_id=mission.id) }}" onsubmit="return confirm('Supprimer votre offre ?');" style="display:inline">
                      <input type="hidden" name="user" value="{{ offre.user }}">
                      <input type="hidden" name="prix" value="{{ offre.prix }}">
                      <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% endif %}

        {% if session.get('user') and session['user'] != mission.vendeur %}
          {% if mission.quantity > 0 %}
            <form method="POST" action="{{ url_for('mission_detail', mission_id=mission.id) }}">
              <label for="prix" class="form-label">Proposez votre prix :</label>
              <input type="number" name="prix" min="1" class="form-control mb-2" placeholder="Entrez votre offre librement" required>
              <button type="submit" class="btn btn-outline-primary w-100">Faire une offre</button>
            </form>
          {% else %}
            <div class="alert alert-warning text-center">Stock épuisé, vous ne pouvez plus faire d'offres.</div>
          {% endif %}
        {% endif %}

        <div class="d-flex gap-2 mt-2">
          <a href="{{ url_for('listing') }}" class="btn btn-secondary w-100">Retour au listing</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
